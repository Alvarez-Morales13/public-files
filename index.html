<!doctype html>
<html lang="es">
<head>
 <meta charset="utf-8">
 <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
 <title>Galaxia para ti</title>
 <style>
 html,body{margin:0;height:100%;background:#000;overflow:hidden}
 #galaxy-canvas{position:fixed;inset:0;width:100%;height:100%;display:block;touch-action:none}
 .attribution{position:fixed;left:10px;bottom:10px;font-size:11px;color:#b9a0ff;opacity:.8;background:rgba(0,0,0,.35);padding:6px 8px;border-radius:8px}
 .player{position:fixed;left:10px;right:10px;bottom:10px;display:flex;gap:8px;align-items:center;
 background:rgba(20,15,35,.35);border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:8px;
 backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);color:#fff;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial}
 .player button{padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.08);color:#fff;cursor:pointer}
 .pill{position:fixed;top:10px;left:50%;transform:translateX(-50%);padding:6px 12px;border-radius:999px;
 background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.18);color:#fff;font:12px -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial}
 .error{position:fixed;inset:auto 10px 70px 10px;background:#260015;color:#ffd9f7;border:1px solid #ff8ae5;border-radius:10px;padding:10px;font:12px system-ui;display:none;}
 </style>
 <!-- CARGA DE LIBRERIAS ORIGINALES -->
 <script src="https://cdn.jsdelivr.net"></script>
 <script src="https://cdn.jsdelivr.net"></script>
</head>
<body>
<canvas id="galaxy-canvas"></canvas>
<div class="pill">Te Amo Infinitamente Mi Princesa Hermosa </div>
<div class="attribution">Base: Para Nathy </div>
<div id="err" class="error"></div>
<div class="player">
 <button id="playBtn">▶</button>
 <span style="font-size:12px;opacity:.9">Escuchando: <b>Margaret - Lana Del Rey</b></span>
 <audio id="audio" preload="auto" loop>
  <source src="margaret.mp3" type="audio/mpeg">
 </audio>
</div>
<canvas id="fx" style="position:fixed;inset:0;pointer-events:none;"></canvas>

<script>
(function(){
const err = document.getElementById('err');
function showError(msg){ err.textContent = msg; err.style.display='block'; }
const audio = document.getElementById('audio');
const playBtn = document.getElementById('playBtn');

// Control de Audio
playBtn.onclick = async () => {
 try { 
  if (audio.paused) { await audio.play(); playBtn.textContent='⏸'; } 
  else { audio.pause(); playBtn.textContent='▶'; } 
 } catch(e){ showError('Haz clic en la pantalla primero.'); }
};

// Activar sonido con el primer clic para la galaxia
document.addEventListener('click', () => {
    if(audio.paused) {
        audio.play().catch(()=>{});
        playBtn.textContent='⏸';
    }
}, {once: true});

// ====== RENDERIZADO DE LA GALAXIA (RESTAURADO) ======
try {
const canvas = document.getElementById('galaxy-canvas');
const renderer = new THREE.WebGLRenderer({ canvas, antialias:true, alpha:false });
renderer.setPixelRatio(Math.min(2, window.devicePixelRatio||1));
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.outputEncoding = THREE.sRGBEncoding;

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 2000);
const controls = new THREE.OrbitControls(camera, renderer.domElement);
controls.enableDamping = true; controls.dampingFactor = 0.06;
controls.minDistance = 10; controls.maxDistance = 220;

function setCam(){
 const w = window.innerWidth, h = window.innerHeight;
 const isMobile = w < 768 || w < h;
 camera.position.set(0, isMobile? 26 : 22, isMobile? 110 : 75);
 camera.updateProjectionMatrix();
} setCam();

// Estrellas de fondo reales
function makePrettyStarTexture(size=1024, count=2600) {
 const c = document.createElement('canvas'); c.width = c.height = size;
 const g = c.getContext('2d');
 g.fillStyle = '#000'; g.fillRect(0,0,size,size);
 for (let i=0;i<count;i++) {
  const x = Math.random()*size, y = Math.random()*size;
  g.fillStyle = 'rgba(255,255,255,'+(Math.random()*0.8)+')';
  g.beginPath(); g.arc(x,y, Math.random()*1.2+0.6, 0, Math.PI*2); g.fill();
 }
 return new THREE.CanvasTexture(c);
}
const bgGeo = new THREE.SphereGeometry(600, 64, 64);
const starTex = makePrettyStarTexture();
const bg = new THREE.Mesh(bgGeo, new THREE.MeshBasicMaterial({ map: starTex, side: THREE.BackSide }));
scene.add(bg);

// Frases en espiral (Lógica del PDF original)
const galaxy = new THREE.Group(); scene.add(galaxy);
const phrases = ["Pinchecha", "Hermosa", "Mi Bebe", "Mi Cielito", "Hermosota", "Te Amo", "Mi Reina", "Mi Amor", "Te Amo Infinitamente"];
const phraseCount = 180;
const arms = 5, radius = 82;

function makeTextTexture(text){
 const c=document.createElement('canvas'); c.width=1024; c.height=128;
 const g=c.getContext('2d');
 g.font='800 48px Arial'; g.textAlign='center'; g.textBaseline='middle';
 g.fillStyle='#fff'; g.shadowColor='rgba(210,140,255,0.95)'; g.shadowBlur=24;
 g.fillText(text,512,64);
 return new THREE.CanvasTexture(c);
}

for(let i=0;i<phraseCount;i++){
 const tex=makeTextTexture(phrases[i%phrases.length]);
 const spr=new THREE.Sprite(new THREE.SpriteMaterial({ map:tex, transparent:true, depthWrite:false }));
 const perArm = phraseCount/arms;
 const ang = (i%perArm)*(Math.PI*2/perArm);
 const armAng = Math.floor(i/perArm)*(Math.PI*2/arms);
 const dist = Math.pow(i/phraseCount,0.72)*radius;
 spr.position.set(Math.cos(ang+armAng)*dist, (Math.random()-0.5)*10, Math.sin(ang+armAng)*dist);
 spr.scale.set(20,2.6,1); galaxy.add(spr);
}

// Núcleo de la galaxia
const core = new THREE.Mesh(new THREE.SphereGeometry(12,64,64), new THREE.MeshBasicMaterial({ color: 0x140018 }));
scene.add(core);

function animate(){
 requestAnimationFrame(animate);
 const t = performance.now()*0.001;
 galaxy.rotation.y = t * 0.05;
 controls.update();
 renderer.render(scene, camera);
} animate();

// Efecto de corazones
const fx = document.getElementById('fx');
const ctx2 = fx.getContext('2d');
const hearts = [];
function resizeFx(){ fx.width = innerWidth; fx.height = innerHeight; }
addEventListener('resize', resizeFx); resizeFx();

addEventListener('click', (e)=>{
 for(let i=0;i<12;i++) hearts.push({x:e.clientX, y:e.clientY, vx:(Math.random()-0.5)*5, vy:(Math.random()-1)*5, life:1});
});

function loopFx(){
 ctx2.clearRect(0,0,fx.width,fx.height);
 for(let i=hearts.length-1; i>=0; i--){
  const h=hearts[i]; h.x+=h.vx; h.y+=h.vy; h.life-=0.015;
  ctx2.globalAlpha=Math.max(0,h.life);
  ctx2.font = "24px Arial"; ctx2.fillText("❤️", h.x, h.y);
  if(h.life<=0) hearts.splice(i,1);
 }
 requestAnimationFrame(loopFx);
} loopFx();

} catch(e) { showError('Error visual: ' + e.message); }
})();
</script>
</body>
</html>
